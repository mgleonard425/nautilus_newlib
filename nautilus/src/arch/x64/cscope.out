cscope 15 $HOME/nautilus/src/arch/x64               0000041438
	@early_mem.c

23 
	~<Çutus/Çutus.h
>

24 
	~<Çutus/mm.h
>

25 
	~<Çutus/mb_uts.h
>

26 
	~<Çutus/maüos.h
>

27 
	~<Çutus/muÉiboÙ2.h
>

29 * 
mem_»giÚ_ty³s
[6];

31 #iâdeà
NAUT_CONFIG_DEBUG_BOOTMEM


32 #undeà
DEBUG_PRINT


33 
	#DEBUG_PRINT
(
fmt
, 
¬gs
...)

	)

36 
	#BMM_DEBUG
(
fmt
, 
¬gs
...è
	`DEBUG_PRINT
("BOOTMEM: " fmt, ##¬gs)

	)

37 
	#BMM_PRINT
(
fmt
, 
¬gs
...è
	`´štk
("BOOTMEM: " fmt, ##¬gs)

	)

38 
	#BMM_WARN
(
fmt
, 
¬gs
...è
	`WARN_PRINT
("BOOTMEM: " fmt, ##¬gs)

	)

42 
	$¬ch_»£rve_boÙ_»giÚs
 (
mbd
)

44 #ifdeà
NAUT_CONFIG_REAL_MODE_INTERFACE


45 
	`INFO_PRINT
("Reserving Long->Real Interface Segment (%p, size %lu)\n",

46 
NAUT_CONFIG_REAL_MODE_INTERFACE_SEGMENT
*16UL, 65536UL);

47 
	`mm_boÙ_»£rve_mem
((
addr_t
)(
NAUT_CONFIG_REAL_MODE_INTERFACE_SEGMENT
*16UL),

48 (
ulÚg_t
)65536);

50 
	}
}

54 
	$¬ch_d‘eù_mem_m­
 (
mm­_šfo_t
 * 
mm_šfo
,

55 
mem_m­_’Œy_t
 * 
memÜy_m­
,

56 
mbd
)

58 
muÉiboÙ_g
 * 
g
;

59 
ušt32_t
 
n
 = 0;

61 ià(
mbd
 & 7) {

62 
	`·nic
("ERROR: Unaligned multiboot info struct\n");

65 
g
 = (
muÉiboÙ_g
*)(
mbd
+8);

66 
g
->
ty³
 !ğ
MULTIBOOT_TAG_TYPE_MMAP
) {

67 
g
 = (
muÉiboÙ_g
*)((
muÉiboÙ_ušt8_t
*éag + (Ñag->
size
+7)&~7));

70 ià(
g
->
ty³
 !ğ
MULTIBOOT_TAG_TYPE_MMAP
) {

71 
	`·nic
("ERROR:‚o mmapag found\n");

74 
muÉiboÙ_memÜy_m­_t
 * 
mm­
;

76 
mm­
=((
muÉiboÙ_g_mm­
*)
g
)->
’Œ›s
;

77 (
muÉiboÙ_ušt8_t
*)
mm­
 < (muÉiboÙ_ušt8_t*)
g
 +ag->
size
;

78 
mm­
 = (
muÉiboÙ_memÜy_m­_t
*)((
ulÚg_t
)mmap +

79 ((
muÉiboÙ_g_mm­
*)
g
)->
’Œy_size
)) {

82 ià(
n
 > 
MAX_MMAP_ENTRIES
) {

83 
	`·nic
("Reached memory„egion†imit!\n");

86 
ulÚg_t
 
¡¬t
,
’d
;

88 
¡¬t
 = 
	`round_up
(
mm­
->
addr
, 
PAGE_SIZE_4KB
);

89 
’d
 = 
	`round_down
(
mm­
->
addr
 + mm­->
Ën
, 
PAGE_SIZE_4KB
);

91 
memÜy_m­
[
n
].
addr
 = 
¡¬t
;

92 
memÜy_m­
[
n
].
Ën
 = 
’d
-
¡¬t
;

93 
memÜy_m­
[
n
].
ty³
 = 
mm­
->type;

95 
	`BMM_PRINT
("Memory map[%u] - [%p - %p] <%s>\n",

96 
n
,

97 
¡¬t
,

98 
’d
,

99 
mem_»giÚ_ty³s
[
memÜy_m­
[
n
].
ty³
]);

101 ià(
mm­
->
ty³
 =ğ
MULTIBOOT_MEMORY_AVAILABLE
) {

102 
mm_šfo
->
u§bË_¿m
 +ğ
mm­
->
Ën
;

105 ià(
’d
 > (
mm_šfo
->
Ï¡_pâ
 << 
PAGE_SHIFT
)) {

106 
mm_šfo
->
Ï¡_pâ
 = 
’d
 >> 
PAGE_SHIFT
;

109 
mm_šfo
->
tÙ®_mem
 +ğ
’d
-
¡¬t
;

111 ++
n
;

112 ++
mm_šfo
->
num_»giÚs
;

114 
	}
}

	@init.c

23 
	#__NAUTILUS_MAIN__


	)

25 
	~<Çutus/Çutus.h
>

26 
	~<Çutus/·gšg.h
>

27 
	~<Çutus/idt.h
>

28 
	~<Çutus/¥šlock.h
>

29 
	~<Çutus/mb_uts.h
>

30 
	~<Çutus/ıu.h
>

31 
	~<Çutus/m¤.h
>

32 
	~<Çutus/ıuid.h
>

33 
	~<Çutus/smp.h
>

34 
	~<Çutus/œq.h
>

35 
	~<Çutus/th»ad.h
>

36 
	~<Çutus/tim”.h
>

37 
	~<Çutus/idË.h
>

38 
	~<Çutus/³rıu.h
>

39 
	~<Çutus/”ºo.h
>

40 
	~<Çutus/åu.h
>

41 
	~<Çutus/¿ndom.h
>

42 
	~<Çutus/aıi.h
>

43 
	~<Çutus/©omic.h
>

44 
	~<Çutus/mm.h
>

45 
	~<Çutus/libccom·t.h
>

46 
	~<Çutus/b¬r›r.h
>

47 
	~<Çutus/vc.h
>

48 
	~<Çutus/dev.h
>

49 
	~<Çutus/ch¬dev.h
>

50 
	~<Çutus/blkdev.h
>

51 
	~<Çutus/Ãtdev.h
>

52 
	~<Çutus/fs.h
>

53 
	~<Çutus/sh–l.h
>

55 
	~<dev/­ic.h
>

56 
	~<dev/pci.h
>

57 
	~<dev/h³t.h
>

58 
	~<dev/ißpic.h
>

59 
	~<dev/i8254.h
>

60 
	~<dev/ps2.h
>

61 
	~<dev/£rŸl.h
>

62 
	~<dev/vga.h
>

63 #ifdeà
NAUT_CONFIG_VIRTIO_PCI


64 
	~<dev/vœtio_pci.h
>

66 #ifdeà
NAUT_CONFIG_RAMDISK


67 
	~<dev/¿mdisk.h
>

69 #ifdeà
NAUT_CONFIG_ATA


70 
	~<dev/©a.h
>

72 #ifdeà
NAUT_CONFIG_EXT2_FILESYSTEM_DRIVER


73 
	~<fs/ext2/ext2.h
>

75 #ifdeà
NAUT_CONFIG_FAT32_FILESYSTEM_DRIVER


76 
	~<fs/çt32/çt32.h
>

79 #ifdeà
NAUT_CONFIG_NDPC_RT


80 
	~"ndpc_´“m±_th»ads.h
"

83 #ifdeà
NAUT_CONFIG_PALACIOS


84 
	~<Çutus/vmm.h
>

87 #ifdeà
NAUT_CONFIG_REAL_MODE_INTERFACE


88 
	~<Çutus/»®mode.h
>

91 #ifdeà
NAUT_CONFIG_VESA


92 
	~<dev/ve§.h
>

95 
¥šlock_t
 
´štk_lock
;

99 
	#QUANTUM_IN_NS
 (1000000000ULL/
NAUT_CONFIG_HZ
)

	)

101 
nk_sched_cÚfig
 
	gsched_cfg
 = {

102 .
ut_lim™
 = 
NAUT_CONFIG_UTILIZATION_LIMIT
*10000ULL,

103 .
	g¥Üadic_»£rv©iÚ
 = 
NAUT_CONFIG_SPORADIC_RESERVATION
*10000ULL,

104 .
	g­”iodic_»£rv©iÚ
 = 
NAUT_CONFIG_APERIODIC_RESERVATION
*10000ULL,

105 .
	g­”iodic_quªtum
 = 
QUANTUM_IN_NS
,

106 .
	g­”iodic_deçuÉ_´iÜ™y
 = 
QUANTUM_IN_NS
,

110 #ifdeà
NAUT_CONFIG_NDPC_RT


111 
	$ndpc_¹_‹¡
()

113 
	`´štk
("Testing NDPC Library‡nd Executable\n");

119 
	`‹¡_ndpc
();

121 
th»ad_id_t
 
tid
;

123 
	`ndpc_š™_´“m±_th»ads
();

125 
tid
 = 
	`ndpc_fÜk_´“m±_th»ad
();

127 ià(!
tid
) {

128 
	`´štk
("Error in initial fork\n");

133 ià(
tid
!=
	`ndpc_my_´“m±_th»ad
()) {

134 
	`´štk
("Parent!\n");

135 
	`ndpc_još_´“m±_th»ad
(
tid
);

136 
	`´štk
("Joinend with foo\n");

138 
	`´štk
("Child!\n");

142 
	`ndpc_deš™_´“m±_th»ads
();

147 
	}
}

152 
	$sysšfo_š™
 (
sys_šfo
 * 
sys
)

154 
sys
->
cÜe_b¬r›r
 = (
nk_b¬r›r_t
*)
	`m®loc
((nk_barrier_t));

155 ià(!
sys
->
cÜe_b¬r›r
) {

156 
	`ERROR_PRINT
("Could‚ot‡llocate core barrier\n");

159 
	`mem£t
(
sys
->
cÜe_b¬r›r
, 0, (
nk_b¬r›r_t
));

161 ià(
	`nk_b¬r›r_š™
(
sys
->
cÜe_b¬r›r
, sys->
num_ıus
) != 0) {

162 
	`ERROR_PRINT
("Could‚ot create core barrier\n");

163 
out_”r
;

168 
out_”r
:

169 
	`ä“
(
sys
->
cÜe_b¬r›r
);

170  -
EINVAL
;

171 
	}
}

175 
	$ruÁime_š™
 ()

178 #ifdeà
NAUT_CONFIG_LEGION_RT


179 #ifdeà
NAUT_CONFIG_PROFILE


180 
	`nk_š¡rum’t_¡¬t
();

181 
	`nk_š¡rum’t_ÿlib¿‹
(
INSTR_CAL_LOOPS
);

184 
	`run_ËgiÚ_‹¡s
();

185 
	`run_ËgiÚ_‹¡s
();

187 #ifdeà
NAUT_CONFIG_PROFILE


188 
	`nk_š¡rum’t_’d
();

189 
	`nk_š¡rum’t_qu”y
();

194 #ifdeà
NAUT_CONFIG_NDPC_RT


195 
	`ndpc_¹_‹¡
();

198 #ifdeà
NAUT_CONFIG_NESL_RT


199 
	`Ã¦_Çutus_maš
();

201 
	}
}

205 #ifdeà
NAUT_CONFIG_PALACIOS_MGMT_VM


206 *
	gmgmt_vm
;

209 
	$Ïunch_vmm_’vœÚm’t
()

211 #ifdeà
NAUT_CONFIG_PALACIOS


212 
	`nk_vmm_š™
("none");

214 #ifdeà
NAUT_CONFIG_PALACIOS_MGMT_VM


215 
gue¡_¡¬t
;

216 
mgmt_vm
 = 
	`nk_vmm_¡¬t_vm
("mªagem’t-vm",&
gue¡_¡¬t
,0xffffffff);

217 ià(!
mgmt_vm
) {

218 
	`ERROR_PRINT
("Failedo startƒmbedded management VM\n");

223 
	`´štk
("VMƒnvironment†aunched\n");

226 
	}
}

230 
	#NAUT_WELCOME
 \

239 "+===============================================+ \n\n"

	)

242 
Çut_šfo
 * 
smp_­_¡ack_sw™ch
(
ušt64_t
, uint64_t, naut_info*);

245 
	$š™
 (
mbd
,

246 
magic
)

248 
Çut_šfo
 * 
Çut
 = &
Çutus_šfo
;

250 
	`mem£t
(
Çut
, 0, (
Çut_šfo
));

252 
	`vga_—¾y_š™
();

254 
	`¥šlock_š™
(&
´štk_lock
);

256 
	`£tup_idt
();

258 
	`nk_št_š™
(&(
Çut
->
sys
));

261 
	`£rŸl_—¾y_š™
();

263 
	`nk_dev_š™
();

264 
	`nk_ch¬_dev_š™
();

265 
	`nk_block_dev_š™
();

266 
	`nk_Ãt_dev_š™
();

268 
	`nk_vc_´št
(
NAUT_WELCOME
);

270 
	`d‘eù_ıu
();

273 
	`mm_boÙ_š™
(
mbd
);

275 
Çut
->
sys
.
mb_šfo
 = 
	`muÉiboÙ_·r£
(
mbd
, 
magic
);

276 ià(!
Çut
->
sys
.
mb_šfo
) {

277 
	`ERROR_PRINT
("Problem…arsing multiboot header\n");

280 
	`nk_aıi_š™
();

283 
	`smp_—¾y_š™
(
Çut
);

287 
	`nk_numa_š™
();

290 
	`nk_·gšg_š™
(&(
Çut
->
sys
.
mem
), 
mbd
);

293 
	`nk_kmem_š™
();

296 
	`m¤_wr™e
(
MSR_GS_BASE
, (
ušt64_t
)
Çut
->
sys
.
ıus
[0]);

300 
	`mm_boÙ_kmem_š™
();

302 
	`di§bË_8259pic
();

304 
	`i8254_š™
(
Çut
);

308 
	`sysšfo_š™
(&(
Çut
->
sys
));

310 
	`ißpic_š™
(&(
Çut
->
sys
));

312 
	`nk_tim”_š™
();

314 
	`­ic_š™
(
Çut
->
sys
.
ıus
[0]);

316 
	`åu_š™
(
Çut
);

318 
	`nk_¿nd_š™
(
Çut
->
sys
.
ıus
[0]);

320 
	`ps2_š™
(
Çut
);

322 
	`pci_š™
(
Çut
);

324 
	`nk_sched_š™
(&
sched_cfg
);

327 
Çut
 = 
	`smp_­_¡ack_sw™ch
(
	`g‘_cur_th»ad
()->
r¥
, get_cur_thread()->rsp,‚aut);

329 
	`mm_boÙ_kmem_ş—nup
();

331 
	`smp_£tup_xÿÎ_b¥
(
Çut
->
sys
.
ıus
[0]);

333 
	`nk_ıu_tİo_discov”
(
Çut
->
sys
.
ıus
[0]);

334 #ifdeà
NAUT_CONFIG_HPET


335 
	`nk_h³t_š™
();

338 #ifdeà
NAUT_CONFIG_PROFILE


339 
	`nk_š¡rum’t_š™
();

342 #ifdeà
NAUT_CONFIG_REAL_MODE_INTERFACE


343 
	`nk_»®_mode_š™
();

346 #ifdeà
NAUT_CONFIG_VESA


347 
	`ve§_š™
();

351 
	`smp_bršgup_­s
(
Çut
);

353 
	`nk_mwa™_š™
();

354 
	`nk_mwa™_š™
();

356 #ifdeà
NAUT_CONFIG_CXX_SUPPORT


357 
	`nk_cxx_š™
();

359 
	`nk_cxx_š™
();

364 
	`vga_š™
();

365 
	`£rŸl_š™
();

369 
	`¡i
();

371 
	`nk_vc_š™
();

374 #ifdeà
NAUT_CONFIG_VIRTUAL_CONSOLE_CHARDEV_CONSOLE


375 
	`nk_vc_¡¬t_ch¬dev_cÚsŞe
(
NAUT_CONFIG_VIRTUAL_CONSOLE_CHARDEV_CONSOLE_NAME
);

378 #ifdeà
NAUT_CONFIG_RAMDISK


379 
	`nk_¿mdisk_š™
(
Çut
);

382 #ifdeà
NAUT_CONFIG_ATA


383 
	`nk_©a_š™
(
Çut
);

386 #ifdeà
NAUT_CONFIG_VIRTIO_PCI


387 
	`vœtio_pci_š™
(
Çut
);

390 
	`nk_fs_š™
();

392 #ifdeà
NAUT_CONFIG_EXT2_FILESYSTEM_DRIVER


393 #ifdeà
NAUT_CONFIG_RAMDISK_EMBED


394 
	`nk_fs_ext2_©ch
("ramdisk0","rootfs", 1);

398 #ifdeà
NAUT_CONFIG_FAT32_FILESYSTEM_DRIVER


399 #ifdeà
NAUT_CONFIG_RAMDISK_EMBED


400 
	`nk_fs_çt32_©ch
("ramdisk0","rootfs", 1);

404 
	`Ïunch_vmm_’vœÚm’t
();

406 
	`nk_Ïunch_sh–l
("root-shell",0);

408 
	`ruÁime_š™
();

410 
	`´štk
("Nautilus boothread yielding (indefinitely)\n");

413 
	`idË
(
NULL
, NULL);

414 
	}
}

	@main.c

23 
	#__NAUTILUS_MAIN__


	)

25 
	~<¬ch/x64/š™.h
>

33 
	$maš
 (
mbd
,

34 
magic
)

37 
	`š™
(
mbd
, 
magic
);

38 
	}
}

	@mwait.c

23 
	~<Çutus/Çutus.h
>

24 
	~<Çutus/ıuid.h
>

25 
	~<Çutus/mwa™.h
>

28 
	smwa™_šfo
 {

29 
ušt8_t
 
	mavaabË
;

30 
ušt16_t
 
	mmš_lše_size
;

31 
ušt16_t
 
	mmax_lše_size
;

32 
ušt8_t
 
	mšts_as_b»aks
;

33 
ušt8_t
 
	mc0_sub¡©es
;

34 
ušt8_t
 
	mc1_sub¡©es
;

35 
ušt8_t
 
	mc2_sub¡©es
;

36 
ušt8_t
 
	mc3_sub¡©es
;

37 
ušt8_t
 
	mc4_sub¡©es
;

38 } 
	gmwa™
;

41 
ušt8_t


42 
	$has_mwa™
 ()

44 
ıuid_»t_t
 
»t
;

45 
ıuid_ecx_æags
 
f
;

46 
	`ıuid
(
CPUID_FEATURE_INFO
, &
»t
);

47 
f
.
v®
 = 
»t
.
c
;

48  
f
.
mÚ™Ü
;

49 
	}
}

53 
	$dump_mwa™_šfo
 ()

55 
	`´štk
("MONITOR/MWAIT Feature Set:\n");

56 
	`´štk
("\tSm®Ë¡ mÚ™Ü-lšsize: %uB\n", 
mwa™
.
mš_lše_size
);

57 
	`´štk
("\tL¬ge¡ mÚ™Ü-lšsize: %uB\n", 
mwa™
.
max_lše_size
);

58 
	`´štk
("\tSuµÜt š‹¼u± a b»akƒv’ts: %s\n", 
mwa™
.
šts_as_b»aks
 ? "yes" : "no");

59 
	`´štk
("\tNumb” oàC0 sub C-¡©e suµÜ‹d: %u\n", 
mwa™
.
c0_sub¡©es
);

60 
	`´štk
("\tNumb” oàC1 sub C-¡©e suµÜ‹d: %u\n", 
mwa™
.
c1_sub¡©es
);

61 
	`´štk
("\tNumb” oàC2 sub C-¡©e suµÜ‹d: %u\n", 
mwa™
.
c2_sub¡©es
);

62 
	`´štk
("\tNumb” oàC3 sub C-¡©e suµÜ‹d: %u\n", 
mwa™
.
c3_sub¡©es
);

63 
	`´štk
("\tNumb” oàC4 sub C-¡©e suµÜ‹d: %u\n", 
mwa™
.
c4_sub¡©es
);

64 
	}
}

68 
	$nk_mwa™_š™
 ()

70 
ıuid_»t_t
 
»t
;

72 ià(
	`has_mwa™
()) {

73 
	`´štk
("Processor supports MONITOR/MWAITƒxtensions\n");

74 
mwa™
.
avaabË
 = 1;

76 
	`´štk
("MWAIT‚ot supported\n");

80 
	`mem£t
(&
mwa™
, 0, (mwait));

82 
	`ıuid
(0x5, &
»t
);

84 
mwa™
.
mš_lše_size
 = 
»t
.
a
 & 0xffff;

85 
mwa™
.
max_lše_size
 = 
»t
.
b
 & 0xffff;

87 ià(
»t
.
c
 & 0x1) {

88 
mwa™
.
šts_as_b»aks
 = !!(
»t
.
c
 & 0x2);

89 
mwa™
.
c0_sub¡©es
 = 
»t
.
d
 & 0xf;

90 
mwa™
.
c1_sub¡©es
 = (
»t
.
d
 >> 4) & 0xf;

91 
mwa™
.
c2_sub¡©es
 = (
»t
.
d
 >> 8) & 0xf;

92 
mwa™
.
c3_sub¡©es
 = (
»t
.
d
 >> 12) & 0xf;

93 
mwa™
.
c4_sub¡©es
 = (
»t
.
d
 >> 16) & 0xf;

96 
	`dump_mwa™_šfo
();

99 
	}
}

	@numa.c

23 
	~<Çutus/Çutus.h
>

24 
	~<Çutus/numa.h
>

25 
	~<Çutus/mm.h
>

26 
	~<Çutus/maüos.h
>

27 
	~<Çutus/”ºo.h
>

28 
	~<Çutus/aıi.h
>

30 
	#u8
 
ušt8_t


	)

31 
	#u16
 
ušt16_t


	)

32 
	#u32
 
ušt32_t


	)

33 
	#u64
 
ušt64_t


	)

35 
	g¤©_»v
;

38 #iâdeà
NAUT_CONFIG_DEBUG_NUMA


39 #undeà
DEBUG_PRINT


40 
	#DEBUG_PRINT
(
fmt
, 
¬gs
...)

	)

42 
	#NUMA_PRINT
(
fmt
, 
¬gs
...è
	`´štk
("NUMA: " fmt, ##¬gs)

	)

43 
	#NUMA_DEBUG
(
fmt
, 
¬gs
...è
	`DEBUG_PRINT
("NUMA: " fmt, ##¬gs)

	)

44 
	#NUMA_ERROR
(
fmt
, 
¬gs
...è
	`ERROR_PRINT
("NUMA: " fmt, ##¬gs)

	)

47 
	$aıi_bË_´št_¤©_’Œy
 (
aıi_subbË_h—d”
 * 
h—d”
)

50 
	`ACPI_FUNCTION_NAME
("acpi_table_print_srat_entry");

52 ià(!
h—d”
)

55 
h—d”
->
ty³
) {

57 
ACPI_SRAT_TYPE_CPU_AFFINITY
:

59 
aıi_¤©_ıu_affš™y
 *
p
 =

60 
	`cÚš”_of
(
h—d”
, 
aıi_¤©_ıu_affš™y
, header);

61 
u32
 
´oxim™y_domaš
 = 
p
->
´oxim™y_domaš_lo
;

63 ià(
¤©_»v
 >= 2) {

64 
´oxim™y_domaš
 |ğ
p
->
´oxim™y_domaš_hi
[0] << 8;

65 
´oxim™y_domaš
 |ğ
p
->
´oxim™y_domaš_hi
[1] << 16;

66 
´oxim™y_domaš
 |ğ
p
->
´oxim™y_domaš_hi
[2] << 24;

68 
	`NUMA_DEBUG
("SRAT Processor (id[0x%02x]ƒid[0x%02x]) in…roximity domain %d %s\n",

69 
p
->
­ic_id
,…->
loÿl_§pic_eid
,

70 
´oxim™y_domaš
,

71 
p
->
æags
 & 
ACPI_SRAT_CPU_ENABLED


76 
ACPI_SRAT_TYPE_MEMORY_AFFINITY
:

78 
aıi_¤©_mem_affš™y
 *
p
 =

79 
	`cÚš”_of
(
h—d”
, 
aıi_¤©_mem_affš™y
, header);

80 
u32
 
´oxim™y_domaš
 = 
p
->proximity_domain;

82 ià(
¤©_»v
 < 2)

83 
´oxim™y_domaš
 &= 0xff;

84 
	`NUMA_DEBUG
("SRAT Memory (0x%016llx†ength 0x%016llxype 0x%x) in…roximity domain %d %s%s\n",

85 
p
->
ba£_add»ss
,…->
Ëngth
,

86 
p
->
memÜy_ty³
, 
´oxim™y_domaš
,

87 
p
->
æags
 & 
ACPI_SRAT_MEM_ENABLED


89 
p
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE


94 
ACPI_SRAT_TYPE_X2APIC_CPU_AFFINITY
:

96 
aıi_¤©_x2­ic_ıu_affš™y
 *
p
 =

97 (
aıi_¤©_x2­ic_ıu_affš™y
 *)
h—d”
;

98 
	`NUMA_DEBUG
("SRAT Processor (x2apicid[0x%08x]) in"

100 
p
->
­ic_id
,

101 
p
->
´oxim™y_domaš
,

102 (
p
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
) ?

107 
	`NUMA_DEBUG
("Found unsupported SRATƒntry (type = 0x%x)\n",

108 
h—d”
->
ty³
);

111 
	}
}

114 
	$aıi_·r£_x2­ic_affš™y
(
aıi_subbË_h—d”
 *
h—d”
,

115 cÚ¡ 
’d
)

117 
aıi_¤©_x2­ic_ıu_affš™y
 *
´oûssÜ_affš™y
;

119 
´oûssÜ_affš™y
 = (
aıi_¤©_x2­ic_ıu_affš™y
 *)
h—d”
;

121 ià(!
´oûssÜ_affš™y
) {

122  -
EINVAL
;

125 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

126 
i
;

127 
ušt32_t
 
domaš_id
;

129 ià(!(
´oûssÜ_affš™y
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
)) {

130 
	`NUMA_DEBUG
("Processor‡ffinity for disabled x2apic…rocessor...\n");

134 
	`aıi_bË_´št_¤©_’Œy
(
h—d”
);

136 
i
 = 0; i < 
sys
->
num_ıus
; i++) {

137 ià(
sys
->
ıus
[
i
]->
Ïpic_id
 =ğ
´oûssÜ_affš™y
->
­ic_id
) {

138 
domaš_id
 = 
´oûssÜ_affš™y
->
´oxim™y_domaš
;

139 
sys
->
ıus
[
i
]->
domaš
 = sys->
loÿl™y_šfo
.
domašs
[
domaš_id
];

144 ià(
i
==
sys
->
num_ıus
) {

145 
	`NUMA_ERROR
("Affš™y fÜ x2­iø´oûssÜ %x‚Ù found\n",
´oûssÜ_affš™y
->
­ic_id
);

149 
	}
}

153 
	$aıi_bË_·r£_¤©
(
aıi_¤©_’Œy_id
 
id
,

154 
aıi_madt_’Œy_hªdËr
 
hªdËr
, 
max_’Œ›s
)

156  
	`aıi_bË_·r£_’Œ›s
(
ACPI_SIG_SRAT
,

157 (
aıi_bË_¤©
), 
id
,

158 
hªdËr
, 
max_’Œ›s
);

159 
	}
}

163 
	$aıi_·r£_´oûssÜ_affš™y
(
aıi_subbË_h—d”
 * 
h—d”
,

164 cÚ¡ 
’d
)

166 
aıi_¤©_ıu_affš™y
 *
´oûssÜ_affš™y


167 ğ
	`cÚš”_of
(
h—d”
, 
aıi_¤©_ıu_affš™y
, header);

169 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

170 
i
;

171 
ušt32_t
 
domaš_id
;

173 ià(!
´oûssÜ_affš™y
)

174  -
EINVAL
;

176 ià(!(
´oûssÜ_affš™y
->
æags
 & 
ACPI_SRAT_CPU_ENABLED
)) {

177 
	`NUMA_DEBUG
("Processor‡ffinity for disabled…rocessor...\n");

181 
	`aıi_bË_´št_¤©_’Œy
(
h—d”
);

184 
i
 = 0; i < 
sys
->
num_ıus
; i++) {

185 ià(
sys
->
ıus
[
i
]->
Ïpic_id
 =ğ
´oûssÜ_affš™y
->
­ic_id
) {

186 
domaš_id
 = 
´oûssÜ_affš™y
->
´oxim™y_domaš_lo
 |

187 (((*(
ušt32_t
*)(&(
´oûssÜ_affš™y
->
´oxim™y_domaš_hi
))) & 0xffffff) << 8);

189 
sys
->
ıus
[
i
]->
domaš
 = sys->
loÿl™y_šfo
.
domašs
[
domaš_id
];

194 ià(
i
==
sys
->
num_ıus
) {

195 
	`NUMA_ERROR
("Affš™y fÜ…roûssÜ %d‚Ù found\n",
´oûssÜ_affš™y
->
­ic_id
);

199 
	}
}

207 
	$aıi_·r£_memÜy_affš™y
(
aıi_subbË_h—d”
 * 
h—d”
,

208 cÚ¡ 
’d
)

210 
aıi_¤©_mem_affš™y
 *
memÜy_affš™y


211 ğ
	`cÚš”_of
(
h—d”
, 
aıi_¤©_mem_affš™y
, header);

213 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

214 
mem_»giÚ
 * 
mem
 = 
NULL
;

215 
numa_domaš
 * 
domaš
 = 
NULL
;

216 
mem_»giÚ
 * 
’t
 = 
NULL
;

218 ià(!
memÜy_affš™y
)

219  -
EINVAL
;

221 ià(!(
memÜy_affš™y
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
)) {

222 
	`NUMA_DEBUG
("Disabled memory„egion‡ffinity...\n");

226 ià(
memÜy_affš™y
->
Ëngth
 == 0 ) {

227 
	`NUMA_DEBUG
("Whacky†ength zero memory„egion...\n");

231 
	`aıi_bË_´št_¤©_’Œy
(
h—d”
);

233 
mem
 = 
	`mm_boÙ_®loc
((
mem_»giÚ
));

234 ià(!
mem
) {

235 
	`ERROR_PRINT
("Could‚ot‡llocate mem„egion\n");

238 
	`mem£t
(
mem
, 0, (
mem_»giÚ
));

240 
mem
->
domaš_id
 = 
memÜy_affš™y
->
´oxim™y_domaš
 & ((
¤©_»v
 < 2) ? 0xff : 0xffffffff);

241 
mem
->
ba£_addr
 = 
memÜy_affš™y
->
ba£_add»ss
;

242 
mem
->
Ën
 = 
memÜy_affš™y
->
Ëngth
;

243 
mem
->
’abËd
 = 
memÜy_affš™y
->
æags
 & 
ACPI_SRAT_MEM_ENABLED
;

244 
mem
->
hÙ_¶uggabË
 = 
memÜy_affš™y
->
æags
 & 
ACPI_SRAT_MEM_HOT_PLUGGABLE
;

245 
mem
->
nÚvŞ©e
 = 
memÜy_affš™y
->
æags
 & 
ACPI_SRAT_MEM_NON_VOLATILE
;

247 
	`ASSERT
(
mem
->
domaš_id
 < 
MAX_NUMA_DOMAINS
);

249 
	`NUMA_DEBUG
("MemÜy„egiÚ: domaš 0x%lx, ba£ %p,†’ 0x%lx,ƒÇbËd=%d hÙ_¶ug=%d‚v=%d\n", 
mem
->
domaš_id
, mem->
ba£_addr
, mem->
Ën
, mem->
’abËd
, mem->
hÙ_¶uggabË
, mem->
nÚvŞ©e
);

252 ià(
sys
->
loÿl™y_šfo
.
domašs
[
mem
->
domaš_id
] =ğ
NULL
) {

254 
	`NUMA_DEBUG
("Region is in‚ew domain\n");

256 
domaš
 = (
numa_domaš
 *)
	`mm_boÙ_®loc
((numa_domain));

257 ià(!
domaš
) {

258 
	`ERROR_PRINT
("Could‚ot‡llocate NUMA domain\n");

261 
	`mem£t
(
domaš
, 0, (
numa_domaš
));

262 
domaš
->
id
 = 
mem
->
domaš_id
;

263 
	`INIT_LIST_HEAD
(&(
domaš
->
»giÚs
));

264 
	`INIT_LIST_HEAD
(&(
domaš
->
adj_li¡
));

266 ià(
mem
->
domaš_id
 !ğ(
sys
->
loÿl™y_šfo
.
num_domašs
+1)) {

267 
	`NUMA_DEBUG
("Memory„egions‡re‚ot inƒxpected domain order, buthat should be OK\n");

270 
sys
->
loÿl™y_šfo
.
domašs
[
domaš
->
id
] = domain;

271 
sys
->
loÿl™y_šfo
.
num_domašs
++;

274 
	`NUMA_DEBUG
("Region is inƒxisting domain\n");

275 
domaš
 = 
sys
->
loÿl™y_šfo
.
domašs
[
mem
->
domaš_id
];

278 
domaš
->
num_»giÚs
++;

279 
domaš
->
addr_¥aû_size
 +ğ
mem
->
Ën
;

281 
	`NUMA_DEBUG
("Domaš‚ow ha 0x%lx„egiÚ ªd siz0x%lx\n", 
domaš
->
num_»giÚs
, domaš->
addr_¥aû_size
);

283 ià(
	`li¡_em±y
(&
domaš
->
»giÚs
)) {

284 
	`li¡_add
(&
mem
->
’Œy
, &
domaš
->
»giÚs
);

287 
	`li¡_fÜ_—ch_’Œy
(
’t
, &
domaš
->
»giÚs
, 
’Œy
) {

288 ià(
mem
->
ba£_addr
 < 
’t
->base_addr) {

289 
	`NUMA_DEBUG
("Added„egiÚ…riÜØ»giÚ w™h ba£‡dd»s 0x%lx\n",
’t
->
ba£_addr
);

290 
	`li¡_add_
(&
mem
->
’Œy
, &
’t
->entry);

294 
	`li¡_add_
(&
mem
->
’Œy
, &
domaš
->
»giÚs
);

299 
	}
}

303 
	$aıi_·r£_¤©
 (
aıi_bË_h—d”
 * 
hdr
, * 
¬g
)

305 
	`NUMA_DEBUG
("Parsing SRAT...\n");

306 
¤©_»v
 = 
hdr
->
»visiÚ
;

309 
	}
}

313 
	$aıi_·r£_¦™
(
aıi_bË_h—d”
 *
bË
, * 
¬g
)

315 
nk_loÿl™y_šfo
 * 
numa
 = (nk_loÿl™y_šfo*)
¬g
;

316 
aıi_bË_¦™
 * 
¦™
 = (aıi_bË_¦™*)
bË
;

317 #ifdeà
NAUT_CONFIG_DEBUG_NUMA


318 
i
, 
j
;

320 
	`NUMA_DEBUG
("Parsing SLIT...\n");

321 
	`NUMA_DEBUG
("Loÿl™y CouÁ: %Îu\n", 
¦™
->
loÿl™y_couÁ
);

323 
	`NUMA_DEBUG
(" Entries:\n");

324 
	`NUMA_DEBUG
(" ");

325 
i
 = 0; i < 
¦™
->
loÿl™y_couÁ
; i++) {

326 
	`´štk
("%02u ");

328 
	`´štk
("\n");

330 
i
 = 0; i < 
¦™
->
loÿl™y_couÁ
; i++) {

331 
	`NUMA_DEBUG
("%02u ", 
i
);

332 
j
 = 0; j < 
¦™
->
loÿl™y_couÁ
; j++) {

333 
	`´štk
("%02u ", *(
ušt8_t
*)(
¦™
->
’Œy
 + 
i
*¦™->
loÿl™y_couÁ
 + 
j
));

335 
	`´štk
("\n");

338 
	`NUMA_DEBUG
("DONE.\n");

342 
numa
->
numa_m©rix
 = 
	`mm_boÙ_®loc
(
¦™
->
loÿl™y_couÁ
 * slit->locality_count);

343 ià(!
numa
->
numa_m©rix
) {

344 
	`ERROR_PRINT
("Could‚ot‡llocate NUMA matrix\n");

348 
	`memıy
((*)
numa
->
numa_m©rix
,

349 (*)
¦™
->
’Œy
,

350 
¦™
->
loÿl™y_couÁ
 * slit->locality_count);

353 
	}
}

362 
	$¬ch_numa_š™
 (
sys_šfo
 * 
sys
)

364 
	`NUMA_PRINT
("Parsing ACPI NUMA information...\n");

367 ià(
	`aıi_bË_·r£
(
ACPI_SIG_SLIT
, 
aıi_·r£_¦™
, &(
sys
->
loÿl™y_šfo
))) {

368 
	`NUMA_DEBUG
("Unableo…arse SLIT\n");

372 ià(!
	`aıi_bË_·r£
(
ACPI_SIG_SRAT
, 
aıi_·r£_¤©
, &(
sys
->
loÿl™y_šfo
))) {

374 
	`NUMA_DEBUG
("Parsing SRAT_MEMORY_AFFINITYable...\n");

376 ià(
	`aıi_bË_·r£_¤©
(
ACPI_SRAT_MEMORY_AFFINITY
,

377 
aıi_·r£_memÜy_affš™y
, 
NAUT_CONFIG_MAX_CPUS
 * 2)) {

378 
	`NUMA_DEBUG
("Unableo…arse memory‡ffinity\n");

381 
	`NUMA_DEBUG
("DONE.\n");

383 
	`NUMA_DEBUG
("Parsing SRAT_TYPE_X2APIC_CPU_AFFINITYable...\n");

385 ià(
	`aıi_bË_·r£_¤©
(
ACPI_SRAT_TYPE_X2APIC_CPU_AFFINITY
,

386 
aıi_·r£_x2­ic_affš™y
, 
NAUT_CONFIG_MAX_CPUS
)) {

387 
	`NUMA_DEBUG
("Unableo…arse x2apic\n");

390 
	`NUMA_DEBUG
("DONE.\n");

392 
	`NUMA_DEBUG
("Parsing SRAT_PROCESSOR_AFFINITYable...\n");

394 ià(
	`aıi_bË_·r£_¤©
(
ACPI_SRAT_PROCESSOR_AFFINITY
,

395 
aıi_·r£_´oûssÜ_affš™y
,

396 
NAUT_CONFIG_MAX_CPUS
)) {

397 
	`NUMA_DEBUG
("Unableo…arse…rocessor‡ffinity\n");

399 
	`NUMA_DEBUG
("DONE.\n");

403 
	`NUMA_PRINT
("DONE.\n");

406 
	}
}

	@shutdown.c

23 
	~<Çutus/Çutus.h
>

24 
	~<Çutus/Çut_ty³s.h
>

25 
	~<Çutus/ıu.h
>

26 
	~<Çutus/aıi.h
>

27 
	~<Çutus/shutdown.h
>

28 
	~<aıi/aıi.h
>

29 
	~<dev/ps2.h
>

32 
	$»boÙ
 ()

35 
	`outb
(1, 0x92);

38 
	`şi
();

40 
tmp
 = 
	`šb
(
KBD_CMD_REG
);

42 ià(
	`__CHECK_BIT
(
tmp
, 
KBD_BIT_KDATA
)) {

43 
	`šb
(
KBD_DATA_REG
);

45 } 
	`__CHECK_BIT
(
tmp
, 
KBD_BIT_UDATA
));

47 
	`outb
(
KBD_RESET
, 
KBD_CMD_REG
);

51 
	`h®t
();

53 
	}
}

56 
	$aıi_»boÙ
 ()

59 
	}
}

61 
	sshutdown_šfo
 {

62 
ušt32_t
 
	msmi_cmd
;

63 
ušt8_t
 
	maıi_’abË
;

64 
ušt8_t
 
	maıi_di§bË
;

65 
ušt32_t
 
	mpm1a_út
;

66 
ušt32_t
 
	mpm1b_út
;

67 
ušt16_t
 
	m¦p_ty·
;

68 
ušt16_t
 
	m¦p_typb
;

69 
ušt16_t
 
	m¦p_’
;

70 
ušt16_t
 
	msci_’
;

71 
ušt8_t
 
	mpm1_út_Ën
;

72 
ušt32_t
 
	mdsdt
;

73 
ušt64_t
 
	mxdsdt
;

75 
ušt8_t
 
	mshutdown_ok
;

80 
	$Œy_aıi_shutdown
 (
aıi_bË_h—d”
 * 
hdr
, * 
¬g
)

82 
shutdown_šfo
 * 
s
 = (shutdown_šfØ*)
¬g
;

83 
aıi_bË_çdt
 * 
çdt
 = (aıi_bË_çdt*)
hdr
;

85 
	`´štk
("Parsing fadt\n");

87 
s
->
dsdt
 = 
çdt
->dsdt;

88 
s
->
xdsdt
 = 
çdt
->
Xdsdt
;

89 
s
->
smi_cmd
 = 
çdt
->
smi_commªd
;

90 
s
->
aıi_’abË
 = 
çdt
->acpi_enable;

91 
s
->
aıi_di§bË
 = 
çdt
->acpi_disable;

92 
s
->
pm1a_út
 = 
çdt
->
pm1a_cÚŒŞ_block
;

93 
s
->
pm1b_út
 = 
çdt
->
pm1b_cÚŒŞ_block
;

94 
s
->
pm1_út_Ën
 = 
çdt
->
pm1_cÚŒŞ_Ëngth
;

95 
s
->
¦p_’
 = 1<<13;

96 
s
->
sci_’
 = 1;

99 
	}
}

102 
	$g‘_s5
 (
shutdown_šfo
 * 
s
)

104 
aıi_bË_h—d”
 * 
hdr
 = (aıi_bË_h—d”*)(
ušt64_t
)
s
->
dsdt
;

105 
ušt32_t
 
Ën
 = 
hdr
->
Ëngth
;

106 
i
;

107 * 
cursÜ
 = 
NULL
;

109 ià(
	`memcmp
((*)(
ušt64_t
)
s
->
dsdt
, "DSDT", 4)) {

110 
	`´štk
("NOT REALLY DSDT\n");

113 
	`´štk
("dsdˆi © %p,†’=%u\n", (*)
hdr
, 
Ën
);

114 
i
 = 0; i < 
Ën
; i++) {

115 * 
tmp
 = (*)(
ušt64_t
)
s
->
dsdt
 + 
i
;

116 ià(!
	`memcmp
(
tmp
, "_S5_", 4)) {

117 
s
->
shutdown_ok
 = 1;

118 
	`´štk
("found s5\n");

119 
cursÜ
 = 
tmp
;

124 ià(!
s
->
shutdown_ok
) {

125 
	`´štk
("no S5 found\n");

129 ià((*(
cursÜ
-1) == 0x08 || ( *(cursor-2) == 0x08 && *(cursor-1) == '\\')) && *(cursor+4) == 0x12) {

130 
	`´štk
("valid AML for shutdown\n");

132 
cursÜ
 += 5;

133 
cursÜ
 += ((*cursor & 0xc0) >> 6) + 2;

135 ià(*
cursÜ
 == 0x0a) {

136 
cursÜ
++;

139 
s
->
¦p_ty·
 = *
cursÜ
 << 10;

140 
cursÜ
++;

142 ià(*
cursÜ
 == 0x0a) {

143 
cursÜ
++;

145 
s
->
¦p_typb
 = *
cursÜ
 << 10;

151 
	}
}

157 
	$aıi_shutdown
 ()

159 
shutdown_šfo
 
s
;

160 
	`mem£t
(&
s
, 0, (s));

162 ià(
	`aıi_bË_·r£
(
ACPI_SIG_FADT
, 
Œy_aıi_shutdown
, &
s
)) {

163 
out_nßıi
;

166 
	`g‘_s5
(&
s
);

168 ià(!
s
.
shutdown_ok
) {

169 
out_nßıi
;

173 ià(
s
.
sci_’
 == 0) {

174 
out_nßıi
;

177 
	`outw
(
s
.
¦p_ty·
 | s.
¦p_’
, s.
pm1a_út
);

178 ià(
s
.
pm1b_út
) {

179 
	`outw
(
s
.
¦p_typb
 | s.
¦p_’
, ()s.
pm1b_út
);

182 
out_nßıi
:

183 
	`´štk
("System halting.\n");

186 
	`h®t
();

189 
	}
}

	@smp.c

23 
	~<Çutus/Çutus.h
>

24 
	~<Çutus/aıi.h
>

25 
	~<Çutus/smp.h
>

26 
	~<Çutus/sfi.h
>

27 
	~<Çutus/œq.h
>

28 
	~<Çutus/mm.h
>

29 
	~<Çutus/³rıu.h
>

30 
	~<Çutus/numa.h
>

31 
	~<Çutus/ıu.h
>

33 #iâdeà
NAUT_CONFIG_DEBUG_SMP


34 #undeà
DEBUG_PRINT


35 
	#DEBUG_PRINT
(
fmt
, 
¬gs
...)

	)

37 
	#SMP_PRINT
(
fmt
, 
¬gs
...è
	`´štk
("SMP: " fmt, ##¬gs)

	)

38 
	#SMP_DEBUG
(
fmt
, 
¬gs
...è
	`DEBUG_PRINT
("SMP: " fmt, ##¬gs)

	)

39 
	#SMP_ERROR
(
fmt
, 
¬gs
...è
	`ERROR_PRINT
("SMP: " fmt, ##¬gs)

	)

42 
ušt8_t
 
	gmp_’Œy_Ëngths
[5] = {

43 
MP_TAB_CPU_LEN
,

44 
MP_TAB_BUS_LEN
,

45 
MP_TAB_IOAPIC_LEN
,

46 
MP_TAB_IO_INT_LEN
,

47 
MP_TAB_LINT_LEN
,

52 
	$·r£_m±abË_ıu
 (
sys_šfo
 * 
sys
, 
mp_bË_’Œy_ıu
 * 
ıu
)

54 
ıu
 * 
Ãw_ıu
 = 
NULL
;

56 ià(
sys
->
num_ıus
 =ğ
NAUT_CONFIG_MAX_CPUS
) {

57 
	`·nic
("CPU countƒxceeded max (check your .config)\n");

60 if(!(
Ãw_ıu
 = 
	`mm_boÙ_®loc
((
ıu
)))) {

61 
	`·nic
("Couldn't‡llocate CPU struct\n");

63 
	`mem£t
(
Ãw_ıu
, 0, (
ıu
));

65 
Ãw_ıu
->
id
 = 
sys
->
num_ıus
;

66 
Ãw_ıu
->
Ïpic_id
 = 
ıu
->lapic_id;

68 
Ãw_ıu
->
’abËd
 = 
ıu
->enabled;

69 
Ãw_ıu
->
is_b¥
 = 
ıu
->is_bsp;

70 
Ãw_ıu
->
ıu_sig
 = 
ıu
->
sig
;

71 
Ãw_ıu
->
ã©_æags
 = 
ıu
->feat_flags;

72 
Ãw_ıu
->
sy¡em
 = 
sys
;

73 
Ãw_ıu
->
ıu_khz
 = 
	`nk_d‘eù_ıu_äeq
Òew_ıu->
id
);

75 
	`SMP_DEBUG
("CPU %u -- LAPIC ID 0x%x -- F—tu»s: ", 
Ãw_ıu
->
id
,‚ew_ıu->
Ïpic_id
);

76 #ifdeà
NAUT_CONFIG_DEBUG_SMP


77 
	`´štk
("%s", (
Ãw_ıu
->
ã©_æags
 & 1) ? "fpu " : "");

78 
	`´štk
("%s", (
Ãw_ıu
->
ã©_æags
 & (1<<7)) ? "mce " : "");

79 
	`´štk
("%s", (
Ãw_ıu
->
ã©_æags
 & (1<<8)) ? "cx8 " : "");

80 
	`´štk
("%s", (
Ãw_ıu
->
ã©_æags
 & (1<<9)) ? "apic " : "");

81 
	`´štk
("\n");

83 
	`SMP_DEBUG
("\tEÇbËd?=%01d\n", 
Ãw_ıu
->
’abËd
);

84 
	`SMP_DEBUG
("\tBSP?=%01d\n", 
Ãw_ıu
->
is_b¥
);

85 
	`SMP_DEBUG
("\tSigÇtu»=0x%x\n", 
Ãw_ıu
->
ıu_sig
);

86 
	`SMP_DEBUG
("\tF»q=%lu.%03lu MHz\n", 
Ãw_ıu
->
ıu_khz
/1000,‚ew_cpu->cpu_khz%1000);

88 
	`¥šlock_š™
(&
Ãw_ıu
->
lock
);

90 
sys
->
ıus
[sys->
num_ıus
] = 
Ãw_ıu
;

92 
sys
->
num_ıus
++;

93 
	}
}

97 
	$·r£_m±abË_ißpic
 (
sys_šfo
 * 
sys
, 
mp_bË_’Œy_ißpic
 * 
ißpic
)

99 
ißpic
 * 
iß
 = 
NULL
;

100 ià(
sys
->
num_ißpics
 =ğ
NAUT_CONFIG_MAX_IOAPICS
) {

101 
	`·nic
("IOAPIC countƒxceeded max (change it in .config)\n");

104 ià(!(
iß
 = 
	`mm_boÙ_®loc
((
ißpic
)))) {

105 
	`·nic
("Couldn't‡llocate IOAPIC struct\n");

107 
	`mem£t
(
iß
, 0, (
ißpic
));

109 
	`SMP_DEBUG
("IOAPICƒntry:\n");

110 
	`SMP_DEBUG
("\tID=0x%x\n", 
ißpic
->
id
);

111 
	`SMP_DEBUG
("\tV”siÚ=0x%x\n", 
ißpic
->
v”siÚ
);

112 
	`SMP_DEBUG
("\tEÇbËd?=%01d\n", 
ißpic
->
’abËd
);

113 
	`SMP_DEBUG
("\tBa£ Addr=0x%lx\n", 
ißpic
->
addr
);

115 
iß
->
id
 = 
ißpic
->id;

116 
iß
->
v”siÚ
 = 
ißpic
->version;

117 
iß
->
u§bË
 = 
ißpic
->
’abËd
;

118 
iß
->
ba£
 = (
addr_t
)
ißpic
->
addr
;

120 
sys
->
ißpics
[sys->
num_ißpics
] = 
iß
;

121 
sys
->
num_ißpics
++;

122 
	}
}

126 
	$·r£_m±abË_lšt
 (
sys_šfo
 * 
sys
, 
mp_bË_’Œy_lšt
 * 
lšt
)

128 * 
ty³_m­
[4] = {"[INT]", "[NMI]", "[SMI]", "[ExtINT]"};

129 * 
po_m­
[4] = {"[BUS]", "[ActHi]", "[Rsvd]", "[ActLo]"};

130 * 
–_m­
[4] = {"[BUS]", "[Edge]", "[Rsvd]", "[Level]"};

131 
ušt8_t
 
pŞ¬™y
 = 
lšt
->
št_æags
 & 0x3;

132 
ušt8_t
 
Œig_mode
 = (
lšt
->
št_æags
 >> 2) & 0x3;

133 
	`SMP_DEBUG
("LINTƒntry\n");

134 
	`SMP_DEBUG
("\tIÁ Ty³=%s\n", 
ty³_m­
[
lšt
->
št_ty³
]);

135 
	`SMP_DEBUG
("\tPŞ¬™y=%s\n", 
po_m­
[
pŞ¬™y
]);

136 
	`SMP_DEBUG
("\tTrigg” Mode=%s\n", 
–_m­
[
Œig_mode
]);

137 
	`SMP_DEBUG
("\tSrøBu ID=0x%02x\n", 
lšt
->
¤c_bus_id
);

138 
	`SMP_DEBUG
("\tSrøBu IRQ=0x%02x\n", 
lšt
->
¤c_bus_œq
);

139 
	`SMP_DEBUG
("\tD¡ LAPIC ID=0x%02x\n", 
lšt
->
d¡_Ïpic_id
);

140 
	`SMP_DEBUG
("\tD¡ LAPIC LINTIN=0x%02x\n", 
lšt
->
d¡_Ïpic_lštš
);

141 
	}
}

144 
	$·r£_m±abË_iošt
 (
sys_šfo
 * 
sys
, 
mp_bË_’Œy_iošt
 * 
iošt
)

146 * 
ty³_m­
[4] = {"[INT]", "[NMI]", "[SMI]", "[ExtINT]"};

147 * 
po_m­
[4] = {"[BUS]", "[ActHi]", "[Rsvd]", "[ActLo]"};

148 * 
–_m­
[4] = {"[BUS]", "[Edge]", "[Rsvd]", "[Level]"};

149 
ušt8_t
 
pŞ¬™y
 = 
iošt
->
št_æags
 & 0x3;

150 
ušt8_t
 
Œig_mode
 = (
iošt
->
št_æags
 >> 2) & 0x3;

151 
	`SMP_DEBUG
("IOINTƒntry\n");

152 
	`SMP_DEBUG
("\tTy³=%s\n", 
ty³_m­
[
iošt
->
št_ty³
]);

153 
	`SMP_DEBUG
("\tPŞ¬™y=%s\n", 
po_m­
[
pŞ¬™y
]);

154 
	`SMP_DEBUG
("\tTrigg” Mode=%s\n", 
–_m­
[
Œig_mode
]);

155 
	`SMP_DEBUG
("\tSrøBu ID=0x%02x\n", 
iošt
->
¤c_bus_id
);

156 
	`SMP_DEBUG
("\tSrøBu IRQ=0x%02x\n", 
iošt
->
¤c_bus_œq
);

157 
	`SMP_DEBUG
("\tD¡ IOAPIC ID=0x%02x\n", 
iošt
->
d¡_ißpic_id
);

158 
	`SMP_DEBUG
("\tD¡ IOAPIC INT Pš=0x%02x\n", 
iošt
->
d¡_ißpic_štš
);

160 
	`nk_add_št_’Œy
(
Œig_mode
,

161 
pŞ¬™y
,

162 
iošt
->
št_ty³
,

163 
iošt
->
¤c_bus_id
,

164 
iošt
->
¤c_bus_œq
,

165 
iošt
->
d¡_ißpic_štš
,

166 
iošt
->
d¡_ißpic_id
);

167 
	}
}

170 
	$·r£_m±abË_bus
 (
sys_šfo
 * 
sys
, 
mp_bË_’Œy_bus
 * 
bus
)

172 
	`SMP_DEBUG
("Busƒntry\n");

173 
	`SMP_DEBUG
("\tBu ID: 0x%02x\n", 
bus
->
bus_id
);

174 
	`SMP_DEBUG
("\tTy³: %.6s\n", 
bus
->
bus_ty³_¡ršg
);

175 
	`nk_add_bus_’Œy
(
bus
->
bus_id
, bus->
bus_ty³_¡ršg
);

176 
	}
}

178 
ušt8_t


179 
	$blk_cksum_ok
 (
ušt8_t
 * 
mp
, 
Ën
)

181 
sum
 = 0;

183 
Ën
--) {

184 
sum
 +ğ*
mp
++;

187  ((
sum
 & 0xff) == 0);

188 
	}
}

192 
	$·r£_mp_bË
 (
sys_šfo
 * 
sys
, 
mp_bË
 * 
mp
)

194 
couÁ
 = 
mp
->
’Œy_út
;

195 
ušt8_t
 * 
mp_’Œy
;

198 ià(
	`¡ºcmp
((*)&
mp
->
sig
, "PCMP", 4) != 0) {

199 
	`SMP_ERROR
("MP Table unexpected format\n");

202 
mp_’Œy
 = (
ušt8_t
*)&
mp
->
’Œ›s
;

203 
	`SMP_PRINT
("P¬sšg MP TabË (’Œy couÁ=%u)\n", 
mp
->
’Œy_út
);

206 
	`SMP_PRINT
("Verifying MP Table integrity...");

207 ià(!
	`blk_cksum_ok
((
ušt8_t
*)
mp
, mp->
Ën
)) {

208 
	`´štk
("FAIL\n");

209 
	`SMP_ERROR
("Corrupt MP Table detected\n");

211 
	`´štk
("OK\n");

214 
couÁ
--) {

216 
ušt8_t
 
ty³
 = *
mp_’Œy
;

218 
ty³
) {

219 
MP_TAB_TYPE_CPU
:

220 
	`·r£_m±abË_ıu
(
sys
, (
mp_bË_’Œy_ıu
*)
mp_’Œy
);

222 
MP_TAB_TYPE_IOAPIC
:

223 
	`·r£_m±abË_ißpic
(
sys
, (
mp_bË_’Œy_ißpic
*)
mp_’Œy
);

225 
MP_TAB_TYPE_IO_INT
:

226 
	`·r£_m±abË_iošt
(
sys
, (
mp_bË_’Œy_iošt
*)
mp_’Œy
);

228 
MP_TAB_TYPE_BUS
:

229 
	`·r£_m±abË_bus
(
sys
, (
mp_bË_’Œy_bus
*)
mp_’Œy
);

231 
MP_TAB_TYPE_LINT
:

232 
	`·r£_m±abË_lšt
(
sys
, (
mp_bË_’Œy_lšt
*)
mp_’Œy
);

235 
	`SMP_ERROR
("UÃx³ùed MP TabË EÁry (ty³=%d)\n", 
ty³
);

239 
mp_’Œy
 +ğ
mp_’Œy_Ëngths
[
ty³
];

243 
	}
}

246 
mp_æßt_±r_¡ruù
*

247 
	$fšd_mp_poš‹r
 ()

249 * 
cursÜ
 = (*)
BASE_MEM_LAST_KILO
;

255 
cursÜ
 <ğ(*)(
BASE_MEM_LAST_KILO
+
PAGE_SIZE
)) {

257 ià(
	`¡ºcmp
(
cursÜ
, "_MP_", 4) == 0) {

258  (
mp_æßt_±r_¡ruù
*)
cursÜ
;

261 
cursÜ
 += 4;

264 
cursÜ
 = (*)
BIOS_ROM_BASE
;

266 
cursÜ
 <ğ(*)
BIOS_ROM_END
) {

268 ià(
	`¡ºcmp
(
cursÜ
, "_MP_", 4) == 0) {

269  (
mp_æßt_±r_¡ruù
*)
cursÜ
;

272 
cursÜ
 += 4;

275 
	}
}

279 
	$__—¾y_š™_mp
 (
Çut_šfo
 * 
Çut
)

281 
mp_æßt_±r_¡ruù
 * 
mp_±r
;

283 
mp_±r
 = 
	`fšd_mp_poš‹r
();

285 ià(!
mp_±r
) {

286 
	`SMP_ERROR
("Could‚ot find MP floating…ointer struct\n");

290 
Çut
->
sys
.
pic_mode_’abËd
 = !!(
mp_±r
->
mp_ã©2
 & 
PIC_MODE_ON
);

292 
	`SMP_PRINT
("Verifying MP Floating Ptr Struct integrity...");

293 ià(!
	`blk_cksum_ok
((
ušt8_t
*)
mp_±r
, 16)) {

294 
	`´štk
("FAIL\n");

295 
	`SMP_ERROR
("Corrupt MP Floating Ptr Struct detected\n");

298 
	`´štk
("OK\n");

301 
	`·r£_mp_bË
(&(
Çut
->
sys
), (
mp_bË
*)(
ušt64_t
)
mp_±r
->
mp_cfg_±r
);

304 
	}
}

308 
	$aıi_·r£_Ïpic
 (
aıi_subbË_h—d”
 * 
hdr
,

309 cÚ¡ 
’d
)

311 
aıi_madt_loÿl_­ic
 *
p
 =

312 (
aıi_madt_loÿl_­ic
 *)
hdr
;

313 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

314 
ıu
 * 
Ãw_ıu
 = 
NULL
;

317 ià(!(
p
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
)) {

318 
	`SMP_DEBUG
("[ ACPI Disabled CPU ] (skipping)\n");

322 #ifdeà
NAUT_CONFIG_DEBUG_SMP


323 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

326 ià(
sys
->
num_ıus
 =ğ
NAUT_CONFIG_MAX_CPUS
) {

327 
	`·nic
("CPU countƒxceeded max (check your .config)\n");

330 ià(!(
Ãw_ıu
 = 
	`mm_boÙ_®loc
((
ıu
)))) {

331 
	`·nic
("Couldn't‡llocate CPU struct\n");

333 
	`mem£t
(
Ãw_ıu
, 0, (
ıu
));

335 
Ãw_ıu
->
id
 = 
sys
->
num_ıus
;

336 
Ãw_ıu
->
Ïpic_id
 = 
p
->
id
;

337 
Ãw_ıu
->
’abËd
 = 1;

338 
Ãw_ıu
->
ıu_sig
 = 0;

339 
Ãw_ıu
->
ã©_æags
 = 0;

340 
Ãw_ıu
->
sy¡em
 = 
sys
;

341 
Ãw_ıu
->
ıu_khz
 = 
	`nk_d‘eù_ıu_äeq
Òew_ıu->
id
);

342 
Ãw_ıu
->
is_b¥
 = (
p
->
id
 == 0 ? 1 : 0);

344 
	`¥šlock_š™
(&
Ãw_ıu
->
lock
);

346 
sys
->
ıus
[sys->
num_ıus
] = 
Ãw_ıu
;

348 
sys
->
num_ıus
++;

351 
	}
}

353 
	$aıi_·r£_loÿl_x2­ic
 (
aıi_subbË_h—d”
 * 
hdr
,

354 cÚ¡ 
’d
)

356 
aıi_madt_loÿl_x2­ic
 *
p
 =

357 (
aıi_madt_loÿl_x2­ic
 *)
hdr
;

358 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

359 
ıu
 * 
Ãw_ıu
 = 
NULL
;

362 ià(!(
p
->
Ïpic_æags
 & 
ACPI_MADT_ENABLED
)) {

363 
	`SMP_DEBUG
("[ ACPI Disabled CPU (X2APIC) ] (skipping)\n");

367 #ifdeà
NAUT_CONFIG_DEBUG_SMP


368 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

371 ià(
sys
->
num_ıus
 =ğ
NAUT_CONFIG_MAX_CPUS
) {

372 
	`·nic
("CPU countƒxceeded max (check your .config)\n");

375 ià(!(
Ãw_ıu
 = 
	`mm_boÙ_®loc
((
ıu
)))) {

376 
	`·nic
("Couldn't‡llocate CPU struct\n");

379 
	`mem£t
(
Ãw_ıu
, 0, (
ıu
));

381 
Ãw_ıu
->
id
 = 
sys
->
num_ıus
;

382 
Ãw_ıu
->
Ïpic_id
 = 
p
->
loÿl_­ic_id
;

383 
Ãw_ıu
->
’abËd
 = 1;

384 
Ãw_ıu
->
ıu_sig
 = 0;

385 
Ãw_ıu
->
ã©_æags
 = 0;

386 
Ãw_ıu
->
sy¡em
 = 
sys
;

387 
Ãw_ıu
->
ıu_khz
 = 
	`nk_d‘eù_ıu_äeq
Òew_ıu->
id
);

388 
Ãw_ıu
->
is_b¥
 = 0;

390 
	`¥šlock_š™
(&
Ãw_ıu
->
lock
);

392 
sys
->
ıus
[sys->
num_ıus
] = 
Ãw_ıu
;

394 
sys
->
num_ıus
++;

397 
	}
}

399 
	$aıi_·r£_š‹¼u±_ov”ride
 (
aıi_subbË_h—d”
 * 
hdr
,

400 cÚ¡ 
’d
)

402 #ifdeà
NAUT_CONFIG_DEBUG_SMP


403 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

406 
	}
}

408 
	$aıi_·r£_nmi_sourû
 (
aıi_subbË_h—d”
 * 
hdr
,

409 cÚ¡ 
’d
)

411 #ifdeà
NAUT_CONFIG_DEBUG_SMP


412 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

415 
	}
}

417 
	$aıi_·r£_loÿl_­ic_nmi
 (
aıi_subbË_h—d”
 * 
hdr
,

418 cÚ¡ 
’d
)

420 #ifdeà
NAUT_CONFIG_DEBUG_SMP


421 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

424 
	}
}

426 
	$aıi_·r£_loÿl_­ic_ov”ride
 (
aıi_subbË_h—d”
 * 
hdr
,

427 cÚ¡ 
’d
)

429 #ifdeà
NAUT_CONFIG_DEBUG_SMP


430 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

433 
	}
}

435 
	$aıi_·r£_io_§pic
 (
aıi_subbË_h—d”
 * 
hdr
,

436 cÚ¡ 
’d
)

438 #ifdeà
NAUT_CONFIG_DEBUG_SMP


439 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

442 
	}
}

444 
	$aıi_·r£_loÿl_§pic
 (
aıi_subbË_h—d”
 * 
hdr
,

445 cÚ¡ 
’d
)

447 #ifdeà
NAUT_CONFIG_DEBUG_SMP


448 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

451 
	}
}

453 
	$aıi_·r£_š‹¼u±_sourû
 (
aıi_subbË_h—d”
 * 
hdr
,

454 cÚ¡ 
’d
)

456 #ifdeà
NAUT_CONFIG_DEBUG_SMP


457 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

460 
	}
}

462 
	$aıi_·r£_loÿl_x2­ic_nmi
 (
aıi_subbË_h—d”
 * 
hdr
,

463 cÚ¡ 
’d
)

465 #ifdeà
NAUT_CONFIG_DEBUG_SMP


466 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

469 
	}
}

471 
	$aıi_·r£_madt_»£rved
 (
aıi_subbË_h—d”
 * 
hdr
,

472 cÚ¡ 
’d
)

474 #ifdeà
NAUT_CONFIG_DEBUG_SMP


475 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

478 
	}
}

484 
	$aıi_·r£_lšt
 (
aıi_subbË_h—d”
 * 
hdr
,

485 cÚ¡ 
’d
)

488 
	}
}

492 
	$aıi_·r£_ißpic
 (
aıi_subbË_h—d”
 * 
hdr
,

493 cÚ¡ 
’d
)

495 
aıi_madt_io_­ic
 *
p
 =

496 (
aıi_madt_io_­ic
 *)
hdr
;

497 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

498 
ißpic
 * 
iß
 = 
NULL
;

500 #ifdeà
NAUT_CONFIG_DEBUG_SMP


501 
	`aıi_bË_´št_madt_’Œy
(
hdr
);

504 ià(
sys
->
num_ißpics
 =ğ
NAUT_CONFIG_MAX_IOAPICS
) {

505 
	`·nic
("IOAPIC countƒxceeded max (change it in .config\n");

508 ià(!(
iß
 = 
	`mm_boÙ_®loc
((
ißpic
)))) {

509 
	`·nic
("Couldn't‡llocate IOAPIC struct\n");

511 
	`mem£t
(
iß
, 0, (
ißpic
));

514 
iß
->
id
 = 
p
->id;

515 
iß
->
v”siÚ
 = 0;

516 
iß
->
u§bË
 = 1;

517 
iß
->
ba£
 = 
p
->
add»ss
;

519 
sys
->
ißpics
[sys->
num_ißpics
] = 
iß
;

520 
sys
->
num_ißpics
++;

523 
	}
}

528 
	$aıi_bË_·r£_madt
 (
aıi_madt_ty³
 
id
,

529 
aıi_bË_’Œy_hªdËr
 
hªdËr
,

530 
max_’Œ›s
)

532  (
	`aıi_bË_·r£_’Œ›s
(
ACPI_SIG_MADT
,

533 (
aıi_bË_madt
),

534 
id
,

535 
hªdËr
,

536 
max_’Œ›s
) < 0);

537 
	}
}

541 
	$aıi_·r£_madt
 (
aıi_bË_h—d”
 * 
hdr
, * 
¬g
)

543 
aıi_bË_madt
 *
p
 = (aıi_bË_madˆ*)
hdr
;

544 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

545 
pÿt
 = 
p
->
æags
 & 
ACPI_MADT_PCAT_COMPAT
;

547 
	`SMP_DEBUG
("Parsing MADT...\n");

548 
	`SMP_DEBUG
("flags=%x (PCAT_COMPAT=%d (%s))\n",

549 
p
->
æags
, 
pÿt
,…cat ? "Dual PIC" : "Multiple APIC");

551 ià(
pÿt
) {

552 
sys
->
æags
 |ğ
NK_SYS_LEGACY
;

556 
	}
}

560 
	$__—¾y_š™_madt
 (
Çut_šfo
 * 
Çut
)

562 ià(
	`aıi_bË_·r£
(
ACPI_SIG_MADT
, 
aıi_·r£_madt
, 
NULL
) != 0) {

563 
	`SMP_ERROR
("Could‚ot…arse MADT\n");

568 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC
,

569 
aıi_·r£_Ïpic
,

570 
NAUT_CONFIG_MAX_CPUS
) != 0) {

571 
	`SMP_ERROR
("Unableo…arse MADT LAPICƒntries\n");

579 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC
,

580 
aıi_·r£_loÿl_x2­ic
,

581 
NAUT_CONFIG_MAX_CPUS
)) {

582 
	`SMP_ERROR
("Unableo…arse MADT X2APICƒntries\n");

587 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_IO_APIC
,

588 
aıi_·r£_ißpic
,

589 
NAUT_CONFIG_MAX_IOAPICS
) != 0) {

590 
	`SMP_ERROR
("Unableo…arse MADT IOAPICƒntries\n");

594 #ifdeà
NAUT_CONFIG_DEBUG_SMP


597 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_SOURCE
,

598 
aıi_·r£_š‹¼u±_sourû
,

599 
NAUT_CONFIG_MAX_CPUS
)) {

600 
	`SMP_ERROR
("Unableo…arse interrupt sources\n");

604 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_INTERRUPT_OVERRIDE
,

605 
aıi_·r£_š‹¼u±_ov”ride
,

606 
NAUT_CONFIG_MAX_CPUS
)) {

607 
	`SMP_ERROR
("Unableo…arse interrupt overrides\n");

611 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_NMI_SOURCE
,

612 
aıi_·r£_š‹¼u±_sourû
,

613 
NAUT_CONFIG_MAX_CPUS
)) {

614 
	`SMP_ERROR
("Unableo…arse NMI sources\n");

618 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_NMI
,

619 
aıi_·r£_loÿl_­ic_nmi
,

620 
NAUT_CONFIG_MAX_CPUS
)) {

621 
	`SMP_ERROR
("Unableo…arse†ocal‡pic‚mi information\n");

625 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_APIC_OVERRIDE
,

626 
aıi_·r£_loÿl_­ic_ov”ride
,

627 
NAUT_CONFIG_MAX_CPUS
)) {

628 
	`SMP_ERROR
("Unableo…arse†ocal‡pic overrides\n");

632 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_IO_SAPIC
,

633 
aıi_·r£_io_§pic
,

634 
NAUT_CONFIG_MAX_CPUS
)) {

635 
	`SMP_ERROR
("Unableo…arse IO SAPICS\n");

639 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_SAPIC
,

640 
aıi_·r£_loÿl_§pic
,

641 
NAUT_CONFIG_MAX_CPUS
)) {

642 
	`SMP_ERROR
("Unableo…arse†ocal SAPICS\n");

647 ià(
	`aıi_bË_·r£_madt
(
ACPI_MADT_TYPE_LOCAL_X2APIC_NMI
,

648 
aıi_·r£_loÿl_x2­ic_nmi
,

649 
NAUT_CONFIG_MAX_CPUS
)) {

650 
	`SMP_ERROR
("Unableo…arse†ocal X2APIC NMIs\n");

657 
	}
}

661 
	$aıi_bË_·r£_çdt
 (
aıi_madt_ty³
 
id
,

662 
aıi_bË_’Œy_hªdËr
 
hªdËr
,

663 
max_’Œ›s
)

666  (
	`aıi_bË_·r£_’Œ›s
(
ACPI_SIG_FADT
,

667 (
aıi_bË_çdt
),

668 
id
,

669 
hªdËr
,

670 
max_’Œ›s
) < 0);

671 
	}
}

674 
	$aıi_·r£_çdt
(
aıi_bË_h—d”
 * 
hdr
, * 
¬g
)

676 
aıi_bË_çdt
 *
p
 = (aıi_bË_çdˆ*)
hdr
;

677 
sys_šfo
 * 
sys
 = &(
	`nk_g‘_Çutus_šfo
()->sys);

678 
Ëgacy
=0;

679 
i8042
=0;

680 
novga
=0;

681 
nomsi
=0;

683 
	`SMP_DEBUG
("Parsing FADT...\n");

684 
	`SMP_DEBUG
("sy¡em iÁ”ru± mod–: %x\n",
p
->
mod–
);

685 
	`SMP_DEBUG
("boÙ_æags: %x\n",
p
->
boÙ_æags
);

687 
Ëgacy
 = 
p
->
boÙ_æags
 & 
ACPI_FADT_LEGACY_DEVICES
;

688 
i8042
 = 
p
->
boÙ_æags
 & 
ACPI_FADT_8042
;

689 
novga
 = 
p
->
boÙ_æags
 & 
ACPI_FADT_NO_VGA
;

690 
nomsi
 = 
p
->
boÙ_æags
 & 
ACPI_FADT_NO_MSI
;

692 
	`SMP_DEBUG
("flags‡re:†egacy=%d i8042=%d‚ovga=%d‚omsi=%d\n",

693 
Ëgacy
,
i8042
,
novga
,
nomsi
);

695 ià(
Ëgacy
) {

696 
sys
->
æags
 |ğ
NK_SYS_LEGACY
;

700 
	}
}

702 
	$__—¾y_š™_çdt_Ëgacy
(
Çut_šfo
 * 
Çut
)

704 ià(
	`aıi_bË_·r£
(
ACPI_SIG_FADT
, 
aıi_·r£_çdt
, 
NULL
) != 0) {

705 
	`SMP_ERROR
("Could‚ot…arse FADT\n");

710 
	}
}

714 
	$__aıi_cÚfigu»_Ëgacy
(
Çut_šfo
 * 
Çut
)

718 
ušt32_t
 
ißpic_id
;

719 ià(
Çut
->
sys
.
num_ißpics
<1) {

720 
	`SMP_ERROR
("No IOAPICs!\n");

725 
ißpic_id
 = 
Çut
->
sys
.
ißpics
[0]->
id
;

727 
	`SMP_DEBUG
("CÚfiguršg†egacy ISA bu 0 w™h†egacy ISA deviû IRQ 0..15 chªÃËdØfœ¡ ißpiø(id 0x%xèšhMPS³ømªÃr\n",
ißpic_id
);

734 
	`nk_add_bus_’Œy
(0,"ISA");

735 
	`nk_add_št_’Œy
(0,

741 
ißpic_id


744 
	`nk_add_št_’Œy
(0,0,0,0,1,1,
ißpic_id
);

746 
	`nk_add_št_’Œy
(0,0,0,0,3,3,
ißpic_id
);

747 
	`nk_add_št_’Œy
(0,0,0,0,4,4,
ißpic_id
);

748 
	`nk_add_št_’Œy
(0,0,0,0,5,5,
ißpic_id
);

749 
	`nk_add_št_’Œy
(0,0,0,0,6,6,
ißpic_id
);

750 
	`nk_add_št_’Œy
(0,0,0,0,7,7,
ißpic_id
);

751 
	`nk_add_št_’Œy
(0,0,0,0,8,8,
ißpic_id
);

753 
	`nk_add_št_’Œy
(0,0,0,0,10,10,
ißpic_id
);

754 
	`nk_add_št_’Œy
(0,0,0,0,11,11,
ißpic_id
);

755 
	`nk_add_št_’Œy
(0,0,0,0,12,12,
ißpic_id
);

756 
	`nk_add_št_’Œy
(0,0,0,0,13,13,
ißpic_id
);

757 
	`nk_add_št_’Œy
(0,0,0,0,14,14,
ißpic_id
);

758 
	`nk_add_št_’Œy
(0,0,0,0,15,15,
ißpic_id
);

760 
	`SMP_DEBUG
("Legacy configuration finished\n");

763 
	}
}

767 
	$¬ch_—¾y_š™
 (
Çut_šfo
 * 
Çut
)

769 
»t
;

771 
	`SMP_DEBUG
("Checking for MADT\n");

776 ià(
	`__—¾y_š™_madt
(
Çut
) == 0) {

777 
	`SMP_DEBUG
("MADT init succeeded -‚ow‡lso checking for†egacy system via FADT\n");

778 
	`__—¾y_š™_çdt_Ëgacy
(
Çut
);

780 ià(
Çut
->
sys
.
æags
 & 
NK_SYS_LEGACY
) {

781 
	`SMP_DEBUG
("ACPI system with†egacy - configuring\n");

782 ià(
	`__aıi_cÚfigu»_Ëgacy
(
Çut
)) {

783 
	`·nic
("Cannot configure ACPI system with†egacy\n");

786 
out_ok
;

788 
	`SMP_DEBUG
("MADT‚ot…resent or working. Falling back on MP Table\n");

789 ià(
	`__—¾y_š™_mp
(
Çut
) == 0) {

790 
out_ok
;

792 
	`·nic
("Neither ACPI MADT‚or MP Table…resent/working! Cannot detect CPUs. Giving up.\n");

796 
out_ok
:

797 
	`SMP_PRINT
("D‘eùed %u CPUs\n", 
Çut
->
sys
.
num_ıus
);

799 
	}
}

	@
1
.
1
/usr/include
7
58
early_mem.c
init.c
main.c
mwait.c
numa.c
shutdown.c
smp.c
